<!doctype html>

<html>
	<head>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<script src="leaflet/leaflet.js"></script>
		<link rel="stylesheet" href="leaflet/leaflet.fullscreen.css" />
		<script src="leaflet/leaflet.fullscreen.js"></script>
		<style>
			html, body {
				height: 100%;
				margin: 0;
				font-family: 'Open Sans', 'OpenSans-Local';
				font-style: normal;				
			}
			
			#map {
				position: absolute;
				margin:  auto;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
			}
						
		</style>
	</head>
	<body>
		
				<div id="map"></div>
			
		
		
		<script>
				
			
			// map div object, main Leaflet object:
			var map = L.map('map').setView([0,0], 3); 
			map.addControl(new L.Control.Fullscreen());
			
			// base maps
			var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
			
			var geojson;
			var markers = L.featureGroup();
			markers.addTo(map);
			var marker = L.marker([0,0]); 
			var popup;
			var linelatlngs = [];
			var polyline;
			
			map.whenReady( async () => {
				// Get the initial location of the International Space Station (ISS).
				data_geojson = await getLocation();
				let lat = data_geojson.features[0].geometry.coordinates[1];
				let lon = data_geojson.features[0].geometry.coordinates[0];
				let alt = data_geojson.features[0].properties.altitude;
				let time = data_geojson.features[0].properties.timestamp;
				let vel = data_geojson.features[0].properties.velocity;
				popup = L.popup().setContent('lat: ' + lat + '째<br>' + 'lon: ' + lon + '째<br>' + 'alt: ' + alt + ' km<br>' + 'time: ' + unixTimestampSolver(time) + ' (your time)<br>' + 'velocity: ' + vel + ' km/h');
				marker.bindPopup(popup).openPopup();
				marker.setLatLng([lat, lon]);
				map.setView([lat, lon], 5);	
				// Add the ISS location as a source.
				 marker.addTo(markers);
				// Update the source from the API every 2 seconds.
				const updateSource = setInterval(async () => {
					data_geojson = await getLocation(updateSource);
					let lat = data_geojson.features[0].geometry.coordinates[1];
					let lon = data_geojson.features[0].geometry.coordinates[0];
					let alt = data_geojson.features[0].properties.altitude;
					let time = data_geojson.features[0].properties.timestamp;
					let vel = data_geojson.features[0].properties.velocity;
					popup = L.popup().setContent('lat: ' + lat + '째<br>' + 'lon: ' + lon + '째<br>' + 'alt: ' + alt + ' km<br>' + 'time: ' + unixTimestampSolver(time) + ' (your time)<br>' + 'velocity: ' + vel + ' km/h');
					marker.bindPopup(popup).openPopup();
					marker.setLatLng([lat, lon]);
					// Fly the map to the location.
					map.setView([lat, lon]);	
					
					linelatlngs.push([lat, lon]);
					if (polyline != null) {polyline.remove()};
					polyline = L.polyline(linelatlngs, {color: 'red'}).addTo(map);				
				}, 2000);
				 
				async function getLocation(updateSource) {
					console.log('Getting ISS location...')
					// Make a GET request to the API and return the location of the ISS.
					try {
						const response = await fetch(
							'https://api.wheretheiss.at/v1/satellites/25544', { method: 'GET' }
							);
						const data = await response.json();
						console.info('Retrieved ISS location:', data)						
						
						// Return the location of the ISS as GeoJSON.
						return {
							'type': 'FeatureCollection',
							'features': [
								{
									'type': 'Feature',
									'geometry': {
										'type': 'Point',
										'coordinates': [data.longitude, data.latitude]
									},
									"properties": {
										"altitude": data.altitude,
										"timestamp": data.timestamp,
										"velocity": data.velocity
									}
								}
							]
						};
					} catch (err) {
						// If the updateSource interval is defined, clear the interval to stop updating the source.
						if (updateSource) clearInterval(updateSource);
						throw new Error(err);
					}
				}
			});
			
			function unixTimestampSolver(ts) {
				var date = new Date(ts*1000).toLocaleString("hu-HU");
				return date;
			}
			  </script>	
	</body>
</html>