<!doctype html>

<html>
	<head>
		<meta charset="utf-8">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<script src="leaflet/leaflet.js"></script>
		<link rel="stylesheet" href="leaflet/leaflet.fullscreen.css" />
		<script src="leaflet/Leaflet.fullscreen.min.js"></script>		
		<script src="leaflet/chart.js"></script>
		<script src="leaflet/L.terminator.js"></script>
		
		<style>
			html, body {
				height: 100%;
				margin: 0;
				font-family: 'Open Sans', 'OpenSans-Local';
				font-style: normal;				
			}
			
			#map {
				position: absolute;
				margin:  auto;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
			}
			.infopanel {
				display: flex; 
				flex-direction: column;
				background-color: #ffffff;
				border-radius: 3px;
				box-shadow: 3px 3px 8px #00000055;
				padding: 10px;
				min-width: 575px;
			}
			.popuprow {
				display: flex; 
				flex-direction: row; 
				justify-content: space-between;
			}
			.info {
				padding: 6px 8px;
				font: 14px/16px Arial, Helvetica, sans-serif;
				background: white;
				background: rgba(255,255,255,0.8);
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
			}
			.legend {
				line-height: 18px;
				color: #555;
			}
			.legend i {
				width: 18px;
				height: 18px;
				float: left;
				margin-right: 8px;
				opacity: 0.7;
			}
						
		</style>
	</head>
	<body>
		
				<div id="map"></div>
				
				
		<script>
				
			var follow = true;
			var DN = true;
			var openpopup = true;
			
			function changeFollowing() {
				var bFollow = document.getElementById('bFollow');
				if (follow == false) {
					bFollow.innerHTML = "Disable following";
					follow = true;
					console.log('following: ', follow);
				} else if (follow == true) {
					bFollow.innerHTML = "Enable following";	
					follow = false;
					console.log('following: ', follow);				
				}
			};
			
			function changeDN() {
				var bDN = document.getElementById('bDN');
				if (DN == false) {
					bDN.innerHTML = "Disable day/night terminator";
					terminator.setStyle({fillOpacity: 0.2});
					DN = true;
					console.log('dn: ', DN);
				} else if (DN == true) {
					bDN.innerHTML = "Enable day/night terminator";	
					terminator.setStyle({fillOpacity: 0});
					DN = false;
					console.log('dn: ', DN);				
				}
			};
			
			function changeOP() {
				var bOP = document.getElementById('bOP');
				if (openpopup == false) {
					bOP.innerHTML = "Disable info popup";
					openpopup = true;
					console.log('openpopup: ', openpopup);
				} else if (openpopup == true) {
					bOP.innerHTML = "Enable info popup";
					openpopup = false;
					marker.closePopup();
					console.log('openpopup: ', openpopup);				
				}
			};
			
			// base maps
			var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> contributors'
			})

			var carto_attrib = '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>'
			var cartodb_dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {
				attribution: carto_attrib,
				subdomains: 'abcd',
				maxZoom: 20,
				minZoom: 0
			});
			var cartodb_voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {
				attribution: carto_attrib,
				subdomains: 'abcd',
				maxZoom: 20,
				minZoom: 0
			});
			var cartodb_positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {
				attribution: carto_attrib,
				subdomains: 'abcd',
				maxZoom: 20,
				minZoom: 0
			});
			var baseMaps = {
				"OpenStreetMap": OSM,
				"CARTO Dark": cartodb_dark,
				"CARTO Voyager": cartodb_voyager,
				"CARTO Positron": cartodb_positron
			};

			// map div object, main Leaflet object:
			var map = L.map('map', {layers: [cartodb_voyager]}).setView([0,0], 3); 
			map.addControl(new L.Control.Fullscreen());
			map.attributionControl.setPrefix('<a href="https://leafletjs.com" title="A JavaScript library for interactive maps">Leaflet ' + L.version + '</a>');
			var layerControl = L.control.layers(baseMaps, null, {collapsed: false}).addTo(map);
			
			var terminator = L.terminator().addTo(map);
			terminator.setStyle({fillOpacity: 0.2});
			setInterval(function() {
				terminator.setTime();
			}, 60000); // Every minute
			
			var geojson;
			var markers = L.featureGroup();
			markers.addTo(map);
			var marker = L.marker([0,0]); 
			var popup;
			var linelatlngs = [];
			var pointinfo = [];
			var polyline;
			
			var chartControl = L.control({position: 'bottomright'});
			chartControl.onAdd = function (map) {
				
                var chartDiv = L.DomUtil.create('div', 'infopanel');
				var content = 
				`<div>
					<button id="bFollow" onclick="changeFollowing();">Disable following</button>
					<button id="bDN" onclick="changeDN();">Disable day/night terminator</button>
					<button id="bOP" onclick="changeOP();">Disable info popup</button>
				</div>
				<div>
					<canvas id="chart" width="100%" height="300px"></canvas>
				</div>
				<div>
					<canvas id="chart2" width="100%" height="300px"></canvas>
				</div>
				<span id="lastupdate" style="font-size: 10pt; align-self: center; margin-top: 4px; height: 22px;"></span>
				<span style="font-size: 6pt; align-self: center; margin-top: 4px;"><i>Known issue: charts don't update while tab is in background.</i></span>
				`
				
                chartDiv.innerHTML += content;
				return chartDiv;
			};
        	chartControl.addTo(map);

			// CHART
			
			var data = {
				datasets: [
				  { 
					borderColor: "#ff6583",
					backgroundColor: "#ff658355",
					fill: false,
					data: [],
					label: "Latitude (deg)",
					yAxisID: "y1"
				  },
				  {
					borderColor: "#309fe9",
					backgroundColor: "#309fe955",
					fill: false,
					data: [],
					label: "Longitude (deg)",
					yAxisID:"y2"
				  }
				],
				labels: []
			  };
			  
			var options = {
				responsive: true,
				interaction: {
					mode: 'index',
					intersect: false
				},
				elements: {
					rectangle: {
						borderWidth: 2
					},
					point: {
						radius: 0
					}
				},
				layout: {
				  "padding": 0
				},
				legend: {
				  "display": true,
				  "labels": {
					"boxWidth": 16
				  }
				},
				maintainAspectRatio: false,
				responsive: true,
				scales: {
					"y1": { 
							title: {
								display: true,
								text: 'Latitude (deg)'						
							},
							position: 'left',
							afterFit: function(scaleInstance) {
								scaleInstance.width = 90; 
							}
					},
					"y2": {
							title: {
								display: true,
								text: 'Longitude (deg)'						
							},
							position: 'right',
							grid: {
							  drawOnChartArea: false, // only want the grid lines for one axis to show up
							},
							afterFit: function(scaleInstance) {
								scaleInstance.width = 80; 
							}
					}
				},
				tooltips: {
				  "intersect": false,
				  "mode": "index",
				  "position": "nearest",
				  "callbacks": {}
				},
				animation: false
			};
				
			var type = "line";

			var myChart = new Chart(document.getElementById("chart").getContext('2d'), {options: options, data: data, type: type});
			
			var data2 = {
				datasets: [
				  {
					borderColor: "#45bfc0",
					backgroundColor: "#45bfc055",
					fill: false,
					data: [],
					label: "Velocity (km/h)",
					yAxisID:"y3"
				  },
				  {
					borderColor: "#ff9731",
					backgroundColor: "#ff973155",
					fill: false,
					data: [],
					label: "Altitude (km)",
					yAxisID:"y4"
				  }
				],
				labels: []
			  };
			var options2 = {
				responsive: true,
				interaction: {
					mode: 'index',
					intersect: false
				},
				elements: {
					rectangle: {
						borderWidth: 2
					},
					point: {
						radius: 0
					}
				},
				layout: {
				  "padding": 0
				},
				legend: {
				  "display": true,
				  "labels": {
					"boxWidth": 16
				  }
				},
				width: 600,
				maintainAspectRatio: false,
				responsive: true,
				scales: {
					"y3": { 
							title: {
								display: true,
								text: 'Velocity (km/h)'						
							},
							position: 'left',
							afterFit: function(scaleInstance) {
								scaleInstance.width = 90; 
							  }
					},
					"y4": {
							title: {
								display: true,
								text: 'Altitude (km)'						
							},
							position: 'right',
							grid: {
							  drawOnChartArea: false, // only want the grid lines for one axis to show up
							},
							afterFit: function(scaleInstance) {
								scaleInstance.width = 80; 
							  }
					}
				},
				tooltips: {
				  "intersect": false,
				  "mode": "index",
				  "position": "nearest",
				  "callbacks": {}
				},
				animation: false
			};
			
			var myChart2 = new Chart(document.getElementById("chart2").getContext('2d'), {options: options2, data: data2, type: type});
			
			map.whenReady( async () => {
				// get initial location of ISS
				data_geojson = await getLocation();
				let lat = data_geojson.features[0].geometry.coordinates[1];
				let lon = data_geojson.features[0].geometry.coordinates[0];
				let alt = data_geojson.features[0].properties.altitude;
				let time = data_geojson.features[0].properties.timestamp;
				let vel = data_geojson.features[0].properties.velocity;
				let vis = data_geojson.features[0].properties.visibility;
				popup = L.popup().setContent('<div style="display: flex; flex-direction: column; "><div style="font-weight: bold; margin-bottom: 8px; align-self: center;">International Space Station</div><div style="display: flex; flex-direction: column;"><div class="popuprow"><span>Latitude:</span><span>' + lat.toFixed(7) + '°</span></div><div class="popuprow"><span>Longitude:</span><span>' + lon.toFixed(7) + '°</span></div>' + '<div class="popuprow"><span>Altitude:</span><span>' + alt.toFixed(3) + ' km</span></div>' + '<div class="popuprow"><span>Velocity:</span><span>' + vel.toFixed(3) + ' km/h</span></div>' + '<div class="popuprow"><span>Visibility:</span><span>' + vis + '</span></div>' + '<div class="popuprow"><span>Browser time:</span><span>' + unixTimestampSolver(time, "full") + '</span></div></div></div>');
				marker.bindPopup(popup).openPopup();
				marker.setLatLng([lat, lon]);
				map.setView([lat, lon], 5);	
				marker.addTo(markers);

				// retrieve every 2 secs:
				const updateSource = setInterval(async () => {
					data_geojson = await getLocation(updateSource);
					let lat = data_geojson.features[0].geometry.coordinates[1];
					let lon = data_geojson.features[0].geometry.coordinates[0];
					let alt = data_geojson.features[0].properties.altitude;
					let time = data_geojson.features[0].properties.timestamp;
					let vel = data_geojson.features[0].properties.velocity;
					let vis = data_geojson.features[0].properties.visibility;
					
					// marker update
					popup = L.popup().setContent('<div style="display: flex; flex-direction: column; "><div style="font-weight: bold; margin-bottom: 8px; align-self: center; font-size: 10pt;">International Space Station</div><div style="display: flex; flex-direction: column;"><div class="popuprow"><span>Latitude:</span><span>' + lat.toFixed(7) + '°</span></div><div class="popuprow"><span>Longitude:</span><span>' + lon.toFixed(7) + '°</span></div>' + '<div class="popuprow"><span>Altitude:</span><span>' + alt.toFixed(3) + ' km</span></div>' + '<div class="popuprow"><span>Velocity:</span><span>' + vel.toFixed(3) + ' km/h</span></div>' + '<div class="popuprow"><span>Visibility:</span><span>' + vis + '</span></div>' + '<div class="popuprow"><span>Browser time:</span><span>' + unixTimestampSolver(time, "full") + '</span></div></div></div>');
					marker.bindPopup(popup, {autoPan:false, minWidth: 206});
					if (openpopup) {
						marker.openPopup();
					};
					marker.setLatLng([lat, lon]);
					if (follow) {
						map.setView([lat, lon]);
					};
					
					// polyline update
					linelatlngs.push([lat, lon]);
					pointinfo.push({"coords": [lat, lon], "altitude": alt, "timestamp": time, "velocity": vel});
					if (polyline != null) {polyline.remove()};
					polyline = L.polyline(linelatlngs, {color: 'red', attribution: "<a href='https://wheretheiss.at/w/developer'>ISS data: WTIA REST API (Bill Shupp / © 2013 Linzig, LLC)</a>"}).addTo(map);	
					
					// UI timestamp update
					var lastupdate_element = document.getElementById('lastupdate');
					lastupdate_element.innerHTML = `Last update: ` + unixTimestampSolver(time, "full");
					
					// chart update
					myChart.data.datasets[0].data.push(lat);
					myChart.data.datasets[1].data.push(lon);
					myChart.data.labels.push(unixTimestampSolver(time, "hhmmss"));
					myChart2.data.datasets[0].data.push(vel);
					myChart2.data.datasets[1].data.push(alt);
					myChart2.data.labels.push(unixTimestampSolver(time, "hhmmss"));
					myChart.update();	
					myChart2.update();									
				}, 2000);
				 
				async function getLocation(updateSource) {
					console.log('Getting ISS location...')
					// GET request
					try {
						console.time('Request took');
						const response = await fetch(
							'https://api.wheretheiss.at/v1/satellites/25544', { method: 'GET' }
							);
						console.timeEnd('Request took');
						
						const data = await response.json();
						console.info('Retrieved ISS location:', data)						
						
						// return as GEOJSON
						return {
							'type': 'FeatureCollection',
							'features': [
								{
									'type': 'Feature',
									'geometry': {
										'type': 'Point',
										'coordinates': [data.longitude, data.latitude]
									},
									"properties": {
										"altitude": data.altitude,
										"timestamp": data.timestamp,
										"velocity": data.velocity,
										"visibility": data.visibility
									}
								}
							]
						};
					} catch (err) {
						if (updateSource) clearInterval(updateSource);
						throw new Error(err);
					}
				}
			});
			
			function unixTimestampSolver(ts, mode) {
				if (mode == "hhmmss") {
					var date = new Date(ts*1000).toLocaleString("hu-HU", {hour: '2-digit', minute: '2-digit', second: '2-digit'});				
				} else if (mode == "full") {
					var date = new Date(ts*1000).toLocaleString("hu-HU");				
				} else if (mode == "fullutc") {
					var date = new Date(ts*1000).toUTCString();				
				}
				return date;
			}
				
			  </script>	
	</body>
</html>